#!/usr/bin/env sh
set -u
LC_ALL=C
export LC_ALL
umask 022

Echo() {
	printf '%s\n' "$*"
}

Die() {
	s=$?
	Echo "$1" >&2
	exit ${2:-$s}
}

ExecDie() {
	Echo "# $*"
	"$@" || Die "$* returned $?"
}

Usage() {
	Echo "Usage: ${0##*/} [options] [--] [git commit options]
The current directory with all its content is commited.
This is roughly equivalent to
	git add --all .
	git commit -a [git commit options]
but possibly also exports GPG_TTY.

Options:
-t Set GPG_TTY to current tty (default)
-T Do not modify GPG_TTY
-h Show this help

If you want to sign, use git commit option -S or
	git config commit.gpgsign true

Another frequently used git commit option: --amend"
	exit ${1:-1}
}

gettty=:
OPTIND=1
while getopts 'tThH' opt
do	case $opt in
	t)	gettty=:;;
	T)	gettty=false;;
	'?')	exit 1;;
	*)	Usage 0;;
	esac
done
shift $(( $OPTIND - 1 ))

if $gettty
then	GPG_TTY=`tty` && [ -n "${GPG_TTY:++}" ] && export GPG_TTY \
		|| unset GPG_TTY
fi

ExecDie git add --all .
ExecDie git commit -a ${1+"$@"}
Echo 'Next steps:
	git-gc
	[git-tag && git-gc]
	git-push'
